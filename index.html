<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Multi-Host Continuous Ping </title>
    <style>
        body {
            font-size: 1.3em;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
            background: #eaf4f7;
            padding: 1.5em;
        }

        h2 {
            font-size: 2em;
            margin-bottom: 0.7em;
            color: #264277;
            text-align: center;
        }

        #pings {
            display: flex;
            flex-wrap: wrap;
            gap: 2em;
            justify-content: center;
            margin-top: 2em;
        }

        .host-box {
            background: #f8f8f8;
            border: 2px solid #678;
            border-radius: 12px;
            font-family: inherit;
            min-width: 480px;
            /* much wider */
            max-width: 720px;
            /* even more room */
            min-height: 400px;
            /* much taller */
            max-height: 800px;
            padding: 2.2em 2em 2em 2em;
            margin-bottom: 2em;
            flex: 1 1 520px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 8px 18px #cdecff;
        }

        .host-title {
            font-weight: bold;
            margin-bottom: 1em;
            font-size: 1.3em;
            color: #256;
            letter-spacing: 1px;
        }

        .host-controls {
            margin-bottom: 1em;
        }

        .host-result {
            background: #101010;
            color: #bcecff;
            font-size: 1.18em;
            flex: 1 1 auto;
            margin-top: 0.35em;
            margin-bottom: 0.45em;
            border-radius: 6px;
            padding: 1.5em;
            overflow-y: auto;
            white-space: pre;
            /* preserve formatting and alignment */
            font-family: inherit;
            line-height: 1.38;
            box-shadow: inset 0 0 14px #0257;
            font-weight: 600;
        }

        button {
            font-size: 1.08em;
            padding: 0.45em 1.1em;
            border-radius: 6px;
            border: 2px solid #abc;
            background: #d8efff;
            margin-right: 0.7em;
            cursor: pointer;
            font-family: inherit;
        }

        .exit-line {
            color: #ffe984;
            font-weight: bold;
            font-size: 1.05em;
        }

        #hosts {
            font-size: 1.2em;
            padding: 0.3em;
            width: 38em;
            border-radius: 4px;
            border: 1px solid #6af;
            margin-bottom: 0.5em;
        }

        .controls {
            text-align: center;
            margin-bottom: 2em;
        }
    </style>
</head>

<body>
    <h2>DBOS Ping Checking </h2>
    <div class="controls">
        <input id="hosts" type="text" size="40"
            placeholder="Enter hosts separated by comma (e.g. 8.8.8.8, google.com)" />
        <button onclick="startMultiPing()">Start Pings</button>
        <button onclick="stopAllPings()">Stop All</button>
    </div>
    <div id="pings"></div>
    <script>
        const pings = {}; // { host: { evtSource, div, stopped, resultPre } }

        function startMultiPing() {
            stopAllPings();
            const hosts = document.getElementById('hosts').value.split(',').map(h => h.trim()).filter(Boolean);
            if (hosts.length === 0) {
                alert("Enter at least one host.");
                return;
            }
            const pingArea = document.getElementById('pings');
            pingArea.innerHTML = '';
            hosts.forEach(host => addPingBox(host));
        }

        function addPingBox(host) {
            // Create DOM box
            const div = document.createElement('div');
            div.className = "host-box";
            div.innerHTML = `
        <div class="host-title">üîç ${host}</div>
        <div class="host-controls">
          <button onclick="window.stopOnePing('${host}')">Stop</button>
        </div>
        <pre class="host-result" id="result-${host.replace(/[^a-zA-Z0-9]/g, '_')}"></pre>
      `;
            document.getElementById('pings').appendChild(div);
            const resultPre = div.querySelector('.host-result');

            // Start SSE ping
            const evtSource = new EventSource(`http://localhost:3001/ping-stream?host=${encodeURIComponent(host)}`);
            let stopped = false;
            evtSource.onmessage = function (event) {
                resultPre.textContent += event.data + '\n';
                resultPre.scrollTop = resultPre.scrollHeight;
            };
            evtSource.addEventListener('end', function (event) {
                printExitLine(resultPre, '[Exit: Ping process ended]');
                stopOnePing(host, false);
            });
            evtSource.onerror = function () {
                if (!stopped) printExitLine(resultPre, '[Exit: Ping connection closed]');
                stopOnePing(host, false);
            };
            pings[host] = { evtSource, div, stopped: false, resultPre };
        }

        function stopOnePing(host, print = true) {
            const p = pings[host];
            if (p && p.evtSource) {
                p.evtSource.close();
                if (print && !p.stopped) printExitLine(p.resultPre, '[Exit: Ping stopped by user]');
                p.stopped = true;
            }
        }
        window.stopOnePing = stopOnePing;
        function stopAllPings() {
            Object.keys(pings).forEach(h => stopOnePing(h));
        }

        function printExitLine(targetPre, line) {
            targetPre.innerHTML += `<span class="exit-line">${line}</span>\n`;
            targetPre.scrollTop = targetPre.scrollHeight;
        }
    </script>
</body>

</html>